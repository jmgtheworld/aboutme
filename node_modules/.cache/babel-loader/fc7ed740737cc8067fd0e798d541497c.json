{"ast":null,"code":"/*\n * Copyright (c) 2015, Yahoo Inc. All rights reserved.\n * Copyrights licensed under the New BSD License.\n * See the accompanying LICENSE file for terms.\n */\nconst util = require(\"util\");\n\nconst glob = util.promisify(require(\"glob\"));\n\nconst Handlebars = require(\"handlebars\");\n\nconst fs = require(\"graceful-fs\");\n\nconst readFile = util.promisify(fs.readFile);\n\nconst path = require(\"path\"); // -----------------------------------------------------------------------------\n\n\nconst defaultConfig = {\n  handlebars: Handlebars,\n  extname: \".handlebars\",\n  encoding: \"utf8\",\n  layoutsDir: undefined,\n  // Default layouts directory is relative to `express settings.view` + `layouts/`\n  partialsDir: undefined,\n  // Default partials directory is relative to `express settings.view` + `partials/`\n  defaultLayout: \"main\",\n  helpers: undefined,\n  compilerOptions: undefined,\n  runtimeOptions: undefined\n};\n\nclass ExpressHandlebars {\n  constructor(config = {}) {\n    // Config properties with defaults.\n    Object.assign(this, defaultConfig, config); // save given config to override other settings.\n\n    this.config = config; // Express view engine integration point.\n\n    this.engine = this.renderView.bind(this); // Normalize `extname`.\n\n    if (this.extname.charAt(0) !== \".\") {\n      this.extname = \".\" + this.extname;\n    } // Internal caches of compiled and precompiled templates.\n\n\n    this.compiled = {};\n    this.precompiled = {}; // Private internal file system cache.\n\n    this._fsCache = {};\n  }\n\n  async getPartials(options) {\n    if (typeof this.partialsDir === \"undefined\") {\n      return {};\n    }\n\n    const partialsDirs = Array.isArray(this.partialsDir) ? this.partialsDir : [this.partialsDir];\n    const dirs = await Promise.all(partialsDirs.map(async dir => {\n      let dirPath;\n      let dirTemplates;\n      let dirNamespace; // Support `partialsDir` collection with object entries that contain a\n      // templates promise and a namespace.\n\n      if (typeof dir === \"string\") {\n        dirPath = dir;\n      } else if (typeof dir === \"object\") {\n        dirTemplates = dir.templates;\n        dirNamespace = dir.namespace;\n        dirPath = dir.dir;\n      } // We must have some path to templates, or templates themselves.\n\n\n      if (!dirPath && !dirTemplates) {\n        throw new Error(\"A partials dir must be a string or config object\");\n      }\n\n      const templates = dirTemplates || (await this.getTemplates(dirPath, options));\n      return {\n        templates,\n        namespace: dirNamespace\n      };\n    }));\n    const partials = {};\n\n    for (const dir of dirs) {\n      const {\n        templates,\n        namespace\n      } = dir;\n      const filePaths = Object.keys(templates);\n\n      for (const filePath of filePaths) {\n        const partialName = this._getTemplateName(filePath, namespace);\n\n        partials[partialName] = templates[filePath];\n      }\n    }\n\n    return partials;\n  }\n\n  async getTemplate(filePath, options = {}) {\n    filePath = path.resolve(filePath);\n    const encoding = options.encoding || this.encoding;\n    const cache = options.precompiled ? this.precompiled : this.compiled;\n    let template = options.cache && cache[filePath];\n\n    if (template) {\n      return template;\n    } // Optimistically cache template promise to reduce file system I/O, but\n    // remove from cache if there was a problem.\n\n\n    try {\n      cache[filePath] = this._getFile(filePath, {\n        cache: options.cache,\n        encoding\n      }).then(file => {\n        const compileTemplate = (options.precompiled ? this._precompileTemplate : this._compileTemplate).bind(this);\n        return compileTemplate(file, this.compilerOptions);\n      });\n      template = await cache[filePath];\n      return template;\n    } catch (err) {\n      delete cache[filePath];\n      throw err;\n    }\n  }\n\n  async getTemplates(dirPath, options = {}) {\n    const cache = options.cache;\n    const filePaths = await this._getDir(dirPath, {\n      cache\n    });\n    const templates = await Promise.all(filePaths.map(filePath => {\n      return this.getTemplate(path.join(dirPath, filePath), options);\n    }));\n    const hash = {};\n\n    for (let i = 0; i < filePaths.length; i++) {\n      hash[filePaths[i]] = templates[i];\n    }\n\n    return hash;\n  }\n\n  async render(filePath, context, options = {}) {\n    const encoding = options.encoding || this.encoding;\n    const [template, partials] = await Promise.all([this.getTemplate(filePath, {\n      cache: options.cache,\n      encoding\n    }), options.partials || this.getPartials({\n      cache: options.cache,\n      encoding\n    })]);\n    const helpers = { ...this.helpers,\n      ...options.helpers\n    };\n    const runtimeOptions = { ...this.runtimeOptions,\n      ...options.runtimeOptions\n    }; // Add ExpressHandlebars metadata to the data channel so that it's\n    // accessible within the templates and helpers, namespaced under:\n    // `@exphbs.*`\n\n    const data = { ...options.data,\n      exphbs: { ...options,\n        filePath,\n        helpers,\n        partials,\n        runtimeOptions\n      }\n    };\n\n    const html = this._renderTemplate(template, context, { ...runtimeOptions,\n      data,\n      helpers,\n      partials\n    });\n\n    return html;\n  }\n\n  async renderView(viewPath, options = {}, callback = null) {\n    const context = options;\n    let promise;\n\n    if (!callback) {\n      promise = new Promise((resolve, reject) => {\n        callback = (err, value) => {\n          err !== null ? reject(err) : resolve(value);\n        };\n      });\n    } // Express provides `settings.views` which is the path to the views dir that\n    // the developer set on the Express app. When this value exists, it's used\n    // to compute the view's name. Layouts and Partials directories are relative\n    // to `settings.view` path\n\n\n    let view;\n    const views = options.settings && options.settings.views;\n\n    const viewsPath = this._resolveViewsPath(views, viewPath);\n\n    if (viewsPath) {\n      view = this._getTemplateName(path.relative(viewsPath, viewPath));\n      this.partialsDir = this.config.partialsDir || path.join(viewsPath, \"partials/\");\n      this.layoutsDir = this.config.layoutsDir || path.join(viewsPath, \"layouts/\");\n    }\n\n    const encoding = options.encoding || this.encoding; // Merge render-level and instance-level helpers together.\n\n    const helpers = { ...this.helpers,\n      ...options.helpers\n    }; // Merge render-level and instance-level partials together.\n\n    const partials = { ...(await this.getPartials({\n        cache: options.cache,\n        encoding\n      })),\n      ...(await (options.partials || {}))\n    }; // Pluck-out ExpressHandlebars-specific options and Handlebars-specific\n    // rendering options.\n\n    const renderOptions = {\n      cache: options.cache,\n      encoding,\n      view,\n      layout: \"layout\" in options ? options.layout : this.defaultLayout,\n      data: options.data,\n      helpers,\n      partials,\n      runtimeOptions: options.runtimeOptions\n    };\n\n    try {\n      let html = await this.render(viewPath, context, renderOptions);\n\n      const layoutPath = this._resolveLayoutPath(renderOptions.layout);\n\n      if (layoutPath) {\n        html = await this.render(layoutPath, { ...context,\n          body: html\n        }, { ...renderOptions,\n          layout: undefined\n        });\n      }\n\n      callback(null, html);\n    } catch (err) {\n      callback(err);\n    }\n\n    return promise;\n  } // -- Protected Hooks ----------------------------------------------------------\n\n\n  _compileTemplate(template, options) {\n    return this.handlebars.compile(template.trim(), options);\n  }\n\n  _precompileTemplate(template, options) {\n    return this.handlebars.precompile(template.trim(), options);\n  }\n\n  _renderTemplate(template, context, options) {\n    return template(context, options).trim();\n  } // -- Private ------------------------------------------------------------------\n\n\n  async _getDir(dirPath, options = {}) {\n    dirPath = path.resolve(dirPath);\n    const cache = this._fsCache;\n    let dir = options.cache && cache[dirPath];\n\n    if (dir) {\n      dir = await dir;\n      return dir.concat();\n    }\n\n    const pattern = \"**/*\" + this.extname; // Optimistically cache dir promise to reduce file system I/O, but remove\n    // from cache if there was a problem.\n\n    try {\n      dir = cache[dirPath] = glob(pattern, {\n        cwd: dirPath,\n        follow: true\n      });\n\n      if (options._throwTestError) {\n        // FIXME: not sure how to throw error in glob for test coverage\n        throw new Error(\"test\");\n      }\n\n      dir = await dir;\n      return dir.concat();\n    } catch (err) {\n      delete cache[dirPath];\n      throw err;\n    }\n\n    ;\n  }\n\n  async _getFile(filePath, options = {}) {\n    filePath = path.resolve(filePath);\n    const cache = this._fsCache;\n    const encoding = options.encoding || this.encoding;\n    let file = options.cache && cache[filePath];\n\n    if (file) {\n      return file;\n    } // Optimistically cache file promise to reduce file system I/O, but remove\n    // from cache if there was a problem.\n\n\n    try {\n      cache[filePath] = readFile(filePath, encoding || \"utf8\");\n      file = await cache[filePath];\n      return file;\n    } catch (err) {\n      delete cache[filePath];\n      throw err;\n    }\n\n    ;\n  }\n\n  _getTemplateName(filePath, namespace) {\n    let name = filePath;\n\n    if (name.endsWith(this.extname)) {\n      name = name.substring(0, name.length - this.extname.length);\n    }\n\n    if (namespace) {\n      name = namespace + \"/\" + name;\n    }\n\n    return name;\n  }\n\n  _resolveViewsPath(views, file) {\n    if (!Array.isArray(views)) {\n      return views;\n    }\n\n    let lastDir = path.resolve(file);\n    let dir = path.dirname(lastDir);\n    const absoluteViews = views.map(v => path.resolve(v)); // find the closest parent\n\n    while (dir !== lastDir) {\n      const index = absoluteViews.indexOf(dir);\n\n      if (index >= 0) {\n        return views[index];\n      }\n\n      lastDir = dir;\n      dir = path.dirname(lastDir);\n    } // cannot resolve view\n\n\n    return null;\n  }\n\n  _resolveLayoutPath(layoutPath) {\n    if (!layoutPath) {\n      return null;\n    }\n\n    if (!path.extname(layoutPath)) {\n      layoutPath += this.extname;\n    }\n\n    return path.resolve(this.layoutsDir || \"\", layoutPath);\n  }\n\n}\n\nmodule.exports = ExpressHandlebars;","map":{"version":3,"sources":["/Users/minjo/aboutme/node_modules/express-handlebars/lib/express-handlebars.js"],"names":["util","require","glob","promisify","Handlebars","fs","readFile","path","defaultConfig","handlebars","extname","encoding","layoutsDir","undefined","partialsDir","defaultLayout","helpers","compilerOptions","runtimeOptions","ExpressHandlebars","constructor","config","Object","assign","engine","renderView","bind","charAt","compiled","precompiled","_fsCache","getPartials","options","partialsDirs","Array","isArray","dirs","Promise","all","map","dir","dirPath","dirTemplates","dirNamespace","templates","namespace","Error","getTemplates","partials","filePaths","keys","filePath","partialName","_getTemplateName","getTemplate","resolve","cache","template","_getFile","then","file","compileTemplate","_precompileTemplate","_compileTemplate","err","_getDir","join","hash","i","length","render","context","data","exphbs","html","_renderTemplate","viewPath","callback","promise","reject","value","view","views","settings","viewsPath","_resolveViewsPath","relative","renderOptions","layout","layoutPath","_resolveLayoutPath","body","compile","trim","precompile","concat","pattern","cwd","follow","_throwTestError","name","endsWith","substring","lastDir","dirname","absoluteViews","v","index","indexOf","module","exports"],"mappings":"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","sourcesContent":["/*\n * Copyright (c) 2015, Yahoo Inc. All rights reserved.\n * Copyrights licensed under the New BSD License.\n * See the accompanying LICENSE file for terms.\n */\n\nconst util = require(\"util\");\nconst glob = util.promisify(require(\"glob\"));\nconst Handlebars = require(\"handlebars\");\nconst fs = require(\"graceful-fs\");\nconst readFile = util.promisify(fs.readFile);\nconst path = require(\"path\");\n\n// -----------------------------------------------------------------------------\n\nconst defaultConfig = {\n\thandlebars: Handlebars,\n\textname: \".handlebars\",\n\tencoding: \"utf8\",\n\tlayoutsDir: undefined, // Default layouts directory is relative to `express settings.view` + `layouts/`\n\tpartialsDir: undefined, // Default partials directory is relative to `express settings.view` + `partials/`\n\tdefaultLayout: \"main\",\n\thelpers: undefined,\n\tcompilerOptions: undefined,\n\truntimeOptions: undefined,\n};\n\nclass ExpressHandlebars {\n\tconstructor (config = {}) {\n\t\t// Config properties with defaults.\n\t\tObject.assign(this, defaultConfig, config);\n\n\t\t// save given config to override other settings.\n\t\tthis.config = config;\n\n\t\t// Express view engine integration point.\n\t\tthis.engine = this.renderView.bind(this);\n\n\t\t// Normalize `extname`.\n\t\tif (this.extname.charAt(0) !== \".\") {\n\t\t\tthis.extname = \".\" + this.extname;\n\t\t}\n\n\t\t// Internal caches of compiled and precompiled templates.\n\t\tthis.compiled = {};\n\t\tthis.precompiled = {};\n\n\t\t// Private internal file system cache.\n\t\tthis._fsCache = {};\n\t}\n\n\tasync getPartials (options) {\n\t\tif (typeof this.partialsDir === \"undefined\") {\n\t\t\treturn {};\n\t\t}\n\t\tconst partialsDirs = Array.isArray(this.partialsDir) ? this.partialsDir : [this.partialsDir];\n\n\t\tconst dirs = await Promise.all(partialsDirs.map(async dir => {\n\t\t\tlet dirPath;\n\t\t\tlet dirTemplates;\n\t\t\tlet dirNamespace;\n\n\t\t\t// Support `partialsDir` collection with object entries that contain a\n\t\t\t// templates promise and a namespace.\n\t\t\tif (typeof dir === \"string\") {\n\t\t\t\tdirPath = dir;\n\t\t\t} else if (typeof dir === \"object\") {\n\t\t\t\tdirTemplates = dir.templates;\n\t\t\t\tdirNamespace = dir.namespace;\n\t\t\t\tdirPath = dir.dir;\n\t\t\t}\n\n\t\t\t// We must have some path to templates, or templates themselves.\n\t\t\tif (!dirPath && !dirTemplates) {\n\t\t\t\tthrow new Error(\"A partials dir must be a string or config object\");\n\t\t\t}\n\n\t\t\tconst templates = dirTemplates || await this.getTemplates(dirPath, options);\n\n\t\t\treturn {\n\t\t\t\ttemplates,\n\t\t\t\tnamespace: dirNamespace,\n\t\t\t};\n\t\t}));\n\n\t\tconst partials = {};\n\n\t\tfor (const dir of dirs) {\n\t\t\tconst { templates, namespace } = dir;\n\t\t\tconst filePaths = Object.keys(templates);\n\n\t\t\tfor (const filePath of filePaths) {\n\t\t\t\tconst partialName = this._getTemplateName(filePath, namespace);\n\t\t\t\tpartials[partialName] = templates[filePath];\n\t\t\t}\n\t\t}\n\n\t\treturn partials;\n\t}\n\n\tasync getTemplate (filePath, options = {}) {\n\t\tfilePath = path.resolve(filePath);\n\n\t\tconst encoding = options.encoding || this.encoding;\n\t\tconst cache = options.precompiled ? this.precompiled : this.compiled;\n\t\tlet template = options.cache && cache[filePath];\n\n\t\tif (template) {\n\t\t\treturn template;\n\t\t}\n\n\t\t// Optimistically cache template promise to reduce file system I/O, but\n\t\t// remove from cache if there was a problem.\n\t\ttry {\n\t\t\tcache[filePath] = this._getFile(filePath, { cache: options.cache, encoding })\n\t\t\t\t.then(file => {\n\t\t\t\t\tconst compileTemplate = (options.precompiled ? this._precompileTemplate : this._compileTemplate).bind(this);\n\t\t\t\t\treturn compileTemplate(file, this.compilerOptions);\n\t\t\t\t});\n\t\t\ttemplate = await cache[filePath];\n\t\t\treturn template;\n\t\t} catch (err) {\n\t\t\tdelete cache[filePath];\n\t\t\tthrow err;\n\t\t}\n\t}\n\n\tasync getTemplates (dirPath, options = {}) {\n\t\tconst cache = options.cache;\n\n\t\tconst filePaths = await this._getDir(dirPath, { cache });\n\t\tconst templates = await Promise.all(filePaths.map(filePath => {\n\t\t\treturn this.getTemplate(path.join(dirPath, filePath), options);\n\t\t}));\n\n\t\tconst hash = {};\n\t\tfor (let i = 0; i < filePaths.length; i++) {\n\t\t\thash[filePaths[i]] = templates[i];\n\t\t}\n\t\treturn hash;\n\t}\n\n\tasync render (filePath, context, options = {}) {\n\t\tconst encoding = options.encoding || this.encoding;\n\t\tconst [template, partials] = await Promise.all([\n\t\t\tthis.getTemplate(filePath, { cache: options.cache, encoding }),\n\t\t\toptions.partials || this.getPartials({ cache: options.cache, encoding }),\n\t\t]);\n\t\tconst helpers = { ...this.helpers, ...options.helpers };\n\t\tconst runtimeOptions = { ...this.runtimeOptions, ...options.runtimeOptions };\n\n\t\t// Add ExpressHandlebars metadata to the data channel so that it's\n\t\t// accessible within the templates and helpers, namespaced under:\n\t\t// `@exphbs.*`\n\t\tconst data = {\n\t\t\t...options.data,\n\t\t\texphbs: {\n\t\t\t\t...options,\n\t\t\t\tfilePath,\n\t\t\t\thelpers,\n\t\t\t\tpartials,\n\t\t\t\truntimeOptions,\n\t\t\t},\n\t\t};\n\n\t\tconst html = this._renderTemplate(template, context, {\n\t\t\t...runtimeOptions,\n\t\t\tdata,\n\t\t\thelpers,\n\t\t\tpartials,\n\t\t});\n\n\t\treturn html;\n\t}\n\n\tasync renderView (viewPath, options = {}, callback = null) {\n\t\tconst context = options;\n\n\t\tlet promise;\n\t\tif (!callback) {\n\t\t\tpromise = new Promise((resolve, reject) => {\n\t\t\t\tcallback = (err, value) => { err !== null ? reject(err) : resolve(value); };\n\t\t\t});\n\t\t}\n\n\t\t// Express provides `settings.views` which is the path to the views dir that\n\t\t// the developer set on the Express app. When this value exists, it's used\n\t\t// to compute the view's name. Layouts and Partials directories are relative\n\t\t// to `settings.view` path\n\t\tlet view;\n\t\tconst views = options.settings && options.settings.views;\n\t\tconst viewsPath = this._resolveViewsPath(views, viewPath);\n\t\tif (viewsPath) {\n\t\t\tview = this._getTemplateName(path.relative(viewsPath, viewPath));\n\t\t\tthis.partialsDir = this.config.partialsDir || path.join(viewsPath, \"partials/\");\n\t\t\tthis.layoutsDir = this.config.layoutsDir || path.join(viewsPath, \"layouts/\");\n\t\t}\n\n\t\tconst encoding = options.encoding || this.encoding;\n\n\t\t// Merge render-level and instance-level helpers together.\n\t\tconst helpers = { ...this.helpers, ...options.helpers };\n\n\t\t// Merge render-level and instance-level partials together.\n\t\tconst partials = {\n\t\t\t...await this.getPartials({ cache: options.cache, encoding }),\n\t\t\t...await (options.partials || {}),\n\t\t};\n\n\t\t// Pluck-out ExpressHandlebars-specific options and Handlebars-specific\n\t\t// rendering options.\n\t\tconst renderOptions = {\n\t\t\tcache: options.cache,\n\t\t\tencoding,\n\t\t\tview,\n\t\t\tlayout: \"layout\" in options ? options.layout : this.defaultLayout,\n\n\t\t\tdata: options.data,\n\t\t\thelpers,\n\t\t\tpartials,\n\t\t\truntimeOptions: options.runtimeOptions,\n\t\t};\n\n\t\ttry {\n\t\t\tlet html = await this.render(viewPath, context, renderOptions);\n\t\t\tconst layoutPath = this._resolveLayoutPath(renderOptions.layout);\n\n\t\t\tif (layoutPath) {\n\t\t\t\thtml = await this.render(\n\t\t\t\t\tlayoutPath,\n\t\t\t\t\t{ ...context, body: html },\n\t\t\t\t\t{ ...renderOptions, layout: undefined },\n\t\t\t\t);\n\t\t\t}\n\t\t\tcallback(null, html);\n\t\t} catch (err) {\n\t\t\tcallback(err);\n\t\t}\n\n\t\treturn promise;\n\t}\n\n\t// -- Protected Hooks ----------------------------------------------------------\n\n\t_compileTemplate (template, options) {\n\t\treturn this.handlebars.compile(template.trim(), options);\n\t}\n\n\t_precompileTemplate (template, options) {\n\t\treturn this.handlebars.precompile(template.trim(), options);\n\t}\n\n\t_renderTemplate (template, context, options) {\n\t\treturn template(context, options).trim();\n\t}\n\n\t// -- Private ------------------------------------------------------------------\n\n\tasync _getDir (dirPath, options = {}) {\n\t\tdirPath = path.resolve(dirPath);\n\n\t\tconst cache = this._fsCache;\n\t\tlet dir = options.cache && cache[dirPath];\n\n\t\tif (dir) {\n\t\t\tdir = await dir;\n\t\t\treturn dir.concat();\n\t\t}\n\n\t\tconst pattern = \"**/*\" + this.extname;\n\n\t\t// Optimistically cache dir promise to reduce file system I/O, but remove\n\t\t// from cache if there was a problem.\n\n\t\ttry {\n\t\t\tdir = cache[dirPath] = glob(pattern, {\n\t\t\t\tcwd: dirPath,\n\t\t\t\tfollow: true,\n\t\t\t});\n\t\t\tif (options._throwTestError) {\n\t\t\t\t// FIXME: not sure how to throw error in glob for test coverage\n\t\t\t\tthrow new Error(\"test\");\n\t\t\t}\n\t\t\tdir = await dir;\n\t\t\treturn dir.concat();\n\t\t} catch (err) {\n\t\t\tdelete cache[dirPath];\n\t\t\tthrow err;\n\t\t};\n\t}\n\n\tasync _getFile (filePath, options = {}) {\n\t\tfilePath = path.resolve(filePath);\n\n\t\tconst cache = this._fsCache;\n\t\tconst encoding = options.encoding || this.encoding;\n\t\tlet file = options.cache && cache[filePath];\n\n\t\tif (file) {\n\t\t\treturn file;\n\t\t}\n\n\t\t// Optimistically cache file promise to reduce file system I/O, but remove\n\t\t// from cache if there was a problem.\n\t\ttry {\n\t\t\tcache[filePath] = readFile(filePath, encoding || \"utf8\");\n\t\t\tfile = await cache[filePath];\n\t\t\treturn file;\n\t\t} catch (err) {\n\t\t\tdelete cache[filePath];\n\t\t\tthrow err;\n\t\t};\n\t}\n\n\t_getTemplateName (filePath, namespace) {\n\t\tlet name = filePath;\n\n\t\tif (name.endsWith(this.extname)) {\n\t\t\tname = name.substring(0, name.length - this.extname.length);\n\t\t}\n\n\t\tif (namespace) {\n\t\t\tname = namespace + \"/\" + name;\n\t\t}\n\n\t\treturn name;\n\t}\n\n\t_resolveViewsPath (views, file) {\n\t\tif (!Array.isArray(views)) {\n\t\t\treturn views;\n\t\t}\n\n\t\tlet lastDir = path.resolve(file);\n\t\tlet dir = path.dirname(lastDir);\n\t\tconst absoluteViews = views.map(v => path.resolve(v));\n\n\t\t// find the closest parent\n\t\twhile (dir !== lastDir) {\n\t\t\tconst index = absoluteViews.indexOf(dir);\n\t\t\tif (index >= 0) {\n\t\t\t\treturn views[index];\n\t\t\t}\n\t\t\tlastDir = dir;\n\t\t\tdir = path.dirname(lastDir);\n\t\t}\n\n\t\t// cannot resolve view\n\t\treturn null;\n\t}\n\n\t_resolveLayoutPath (layoutPath) {\n\t\tif (!layoutPath) {\n\t\t\treturn null;\n\t\t}\n\n\t\tif (!path.extname(layoutPath)) {\n\t\t\tlayoutPath += this.extname;\n\t\t}\n\n\t\treturn path.resolve(this.layoutsDir || \"\", layoutPath);\n\t}\n}\n\nmodule.exports = ExpressHandlebars;\n"]},"metadata":{},"sourceType":"script"}